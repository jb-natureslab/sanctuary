<?php
ini_set('display_errors', 1);
ini_set('display_startup_errors', 1);
error_reporting(E_ALL);

// Generated by curl-to-PHP: http://incarnate.github.io/curl-to-php/
$ch = curl_init();

$page = $_GET['page'];
$url = 'https://api.buttondown.email/v1/subscribers';
if($page){
	$url = $url.'?page='.$page;
}

curl_setopt($ch, CURLOPT_URL, $url);
curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1);
curl_setopt($ch, CURLOPT_CUSTOMREQUEST, 'GET');


$headers = array();
$headers[] = 'Authorization: Token a501317c-9cf7-4fb2-bd84-b76d66a31010';
curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);

$result = curl_exec($ch);
if (curl_errno($ch)) {
    echo 'Error:' . curl_error($ch);
}
curl_close($ch);
$result = json_decode($result,true);
foreach($result['results'] as $user){
	print_r($user);
	$email = $user['email'];
	$metadata = $user['metadata'];
	$organisation = $metadata['organisation'];
	$organisationTag = ucwords(str_replace("-", " ", $organisation));
	$json = '
	{
  "email": "'.$email.'",
  "tags": [
    "'.$organisationTag.'"
  ]
}';
	echo $json;
	
	if($email=='jack@natureslaboratory.co.uk'){
		
		$data = "{\"email\":\"'$email\",\"tags\": [\"$organisationTag\"]}";
		$url = "'https://api.buttondown.email/v1/subscribers/".$user['id'];
		
		$headers = array();
		$headers[] = 'Authorization: Token a501317c-9cf7-4fb2-bd84-b76d66a31010';
		$headers[] = array('Content-Type: application/json');
		
		$curl = curl_init();
		curl_setopt($curl, CURLOPT_URL, $url);
		curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1);
		curl_setopt($curl, CURLOPT_CUSTOMREQUEST, 'PATCH');
		curl_setopt($curl, CURLOPT_POSTFIELDS, $data);
		curl_setopt($curl, CURLOPT_HTTPHEADER, $headers);
		$response = curl_exec($curl);
		curl_close($curl);
		$ch = curl_init();
		
		print_r($response);
		
		echo "<hr />";
	}
}
?>